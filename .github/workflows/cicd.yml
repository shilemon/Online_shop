name: Online Shop CI/CD â€“ Blue Green Deployment

on:
  push:
    branches:
      - main

env:
  NAMESPACE: online-shop
  BLUE_DEPLOYMENT: online-shop-blue
  GREEN_DEPLOYMENT: online-shop-green
  SERVICE_NAME: online-shop-blue-deployment-service

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    # -------------------------------
    # 1. Checkout Code
    # -------------------------------
    - name: Checkout Repository
      uses: actions/checkout@v4

    # -------------------------------
    # 2. Verify Tools & Cluster
    # -------------------------------
    - name: Verify Kubernetes Cluster
      run: |
        kubectl cluster-info
        kubectl get nodes

    # -------------------------------
    # 3. Login to Docker Hub
    # -------------------------------
    - name: Docker Hub Login
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # -------------------------------
    # 4. Build & Push GREEN Image
    # -------------------------------
    - name: Build & Push Green Image
      run: |
        docker build -t emon110852/online-shop:latest .
        docker push emon110852/online-shop:latest

    # -------------------------------
    # 5. Create Namespace (Safe)
    # -------------------------------
    - name: Create Namespace
      run: |
        kubectl get ns $NAMESPACE || kubectl apply -f K8s/blue-green-ns.yml

    # -------------------------------
    # 6. Deploy BLUE (Initial Live)
    # -------------------------------
    - name: Deploy Blue Version
      run: |
        kubectl apply -f K8s/blue-deployment.yml

    # -------------------------------
    # 7. Deploy GREEN (New Version)
    # -------------------------------
    - name: Deploy Green Version
      run: |
        kubectl apply -f K8s/green-deployment.yml

    # -------------------------------
    # 8. Wait for GREEN Pods
    # -------------------------------
    - name: Wait for Green Rollout
      run: |
        kubectl rollout status deployment/${GREEN_DEPLOYMENT} -n $NAMESPACE

    # -------------------------------
    # 9. Switch Traffic to GREEN
    # -------------------------------
    - name: Switch Traffic to Green
      run: |
        kubectl patch svc ${SERVICE_NAME} \
          -n $NAMESPACE \
          -p '{"spec":{"selector":{"app":"online-shop-green"}}}'

    # -------------------------------
    # 10. Verify Service Routing
    # -------------------------------
    - name: Verify Service
      run: |
        kubectl get svc ${SERVICE_NAME} -n $NAMESPACE
        kubectl describe svc ${SERVICE_NAME} -n $NAMESPACE
