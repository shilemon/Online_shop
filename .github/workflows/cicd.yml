name: Online Shop CI/CD - Blue Green Deployment

on:
  push:
    branches:
      - main

env:
  NAMESPACE: online-shop
  GREEN_IMAGE: emon110852/online-shop

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Build and Push Green Image
      run: |
        docker build -t $GREEN_IMAGE:latest .
        docker push $GREEN_IMAGE:latest
    
    - name: Create Kind Cluster
      uses: helm/kind-action@v1.10.0
      with:
        cluster_name: online-shop-cluster
        config: kind-cluster/kind-config.yml
        wait: 120s
    
    - name: Verify Cluster
      run: |
        kubectl cluster-info
        kubectl get nodes
    
    - name: Load Image into Kind
      run: |
        kind load docker-image $GREEN_IMAGE:latest --name online-shop-cluster
    
    - name: Create Namespace
      run: |
        kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -
    
    - name: Deploy Green Version
      run: |
        kubectl apply -f K8s/green-deployment.yml
    
    - name: Wait for Green Pods
      run: |
        kubectl rollout status deployment/online-shop-green -n $NAMESPACE --timeout=5m
    
    - name: Display Status
      run: |
        echo "=== Deployments ==="
        kubectl get deployments -n $NAMESPACE
        echo "=== Pods ==="
        kubectl get pods -n $NAMESPACE
        echo "=== Services ==="
        kubectl get services -n $NAMESPACE
