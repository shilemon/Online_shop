name: Online Shop CI/CD â€“ Blue Green Deployment

on:
  push:
    branches:
      - main

env:
  NAMESPACE: online-shop

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build & Push Green Image
      run: |
        docker build -t emon110852/online-shop:latest .
        docker push emon110852/online-shop:latest

    - name: Verify Cluster
      run: |
        kubectl cluster-info
        kubectl get nodes

    - name: Create Namespace
      run: |
        kubectl get ns $NAMESPACE || kubectl apply -f K8s/blue-green-ns.yml

    - name: Deploy Green
      run: |
        kubectl apply -f K8s/green-deployment.yml

    - name: Wait for Green Pods
      run: |
        kubectl rollout status deployment/online-shop-green -n $NAMESPACE

    - name: Switch Traffic to Green
      run: |
        kubectl patch svc online-shop-blue-deployment-service \
        -n $NAMESPACE \
        -p '{"spec":{"selector":{"app":"online-shop-green"}}}'
